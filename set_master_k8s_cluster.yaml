---        
- hosts: master
  gather_facts: no
  vars:
      ansible_python_interpreter: /usr/bin/python3
  tasks:

    - include: k8s-master.yaml

    - set_fact:
        kuctl_weave_output_1: kuctl_weave_output

    - name: Failed reset cluster
      include: reset.yaml
      when: kuctl_weave_output_1.rc != 0

    - include: k8s-master.yaml
      when: kuctl_weave_output_1.rc != 0

    - fail:
        msg: Failed "{{ kuctl_weave_output }}"
      when: kuctl_weave_output.rc != 0
        
- hosts: master
  gather_facts: no
  tasks: 

    - name: get nodes
      shell: kubectl get nodes
      register: nodes_out

    - name: get api key
      shell: kubectl describe secret $(kubectl get secrets | grep default | cut -f1 -d ' ') | grep -E '^token' | cut -f2 -d':' | tr -d '\t'
      register: api_key
